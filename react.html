<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Hello World</title>
  <script src="./lib/react.development-16.2.0.js"></script>
  <script src="./lib/react-dom.development-16.2.0.js"></script>
  <script src="./lib/prop-types-15.6.0.js"></script>
  <script src="./lib/babel.min-6.15.0.js"></script>
  <script src="./lib/vue-2.5.13.js"></script>
  <script src="./lib/vuex-3.0.1.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const storeKey = '$store'
    const subscriptionKey = '$storeSubscription'

    // ------------------------------------------------------------------------
    // STORE CONFIGURATION
    // ------------------------------------------------------------------------
    Vue.use(Vuex)

    const mutationTypes = {
      INCREMENT: 'INCREMENT',
      INCREMENT_START: 'INCREMENT_START',
      INCREMENT_STOP: 'INCREMENT_STOP'
    }
    const actionTypes = {
      INCREMENT_ASYNC: 'INCREMENT_ASYNC'
    }
    const mutations = {
      increment: (value = 1) => ({
        type: mutationTypes.INCREMENT,
        value: value
      })
    }
    const actions = {
      incrementAsync: (value = 1) => ({
        type: actionTypes.INCREMENT_ASYNC,
        value: value
      })
    }

    const store = new Vuex.Store({
      state: {
        count: 0,
        isIncrementing: false
      },
      getters: {
        countGreaterThan2: (state, getters) => state.count > 2
      },
      mutations: {
        [mutationTypes.INCREMENT](state) {
          state.count++
        },
        [mutationTypes.INCREMENT_START](state) {
          state.isIncrementing = true
        },
        [mutationTypes.INCREMENT_STOP](state) {
          state.isIncrementing = false
        }
      },
      actions: {
        [actionTypes.INCREMENT_ASYNC]({commit, state}, payload) {
          commit(mutationTypes.INCREMENT_START)
          return new Promise(resolve => {
            setTimeout(() => {
              commit(mutationTypes.INCREMENT)
              resolve()
            }, 500)
          }).then(() => commit(mutationTypes.INCREMENT_STOP))
          .then(()=>state.count)
        }
      },
      modules: {
        mod1: {
          namespaced: true,
          state: {
            count: 1000,
            isIncrementing: false
          },
          getters: {
            countGreaterThan1002: (state, getters) => state.count > 1002
          },
          mutations: {
            increment(state) {
              state.count++
            },
            incrementStart(state) {
              state.isIncrementing = true
            },
            incrementStop(state) {
              state.isIncrementing = false
            }
          },
          actions: {
            incrementAsync({commit}) {
              commit(mutationTypes.INCREMENT_START)
              return new Promise(resolve => {
                setTimeout(() => {
                  commit(mutationTypes.INCREMENT)
                  resolve()
                }, 500)
              }).then(() => commit(mutationTypes.INCREMENT_STOP))
            }
          }
        }
      }
    })
    // ------------------------------------------------------------------------
    // ------------------------------------------------------------------------


    // ------------------------------------------------------------------------
    // PROVIDER COMPONENT
    // ------------------------------------------------------------------------
    const createProvider = () => {
      class Provider extends React.Component {
        getChildContext() {
          return {
            [storeKey]: this[storeKey],
            [subscriptionKey]: null
          }
        }

        constructor(props, context) {
          super(props, context)
          this[storeKey] = props.store;
        }

        render() {
          return React.Children.only(this.props.children)
        }
      }

      // if (process.env.NODE_ENV !== 'production') {
      //   Provider.prototype.componentWillReceiveProps = function (nextProps) {
      //     if (this[storeKey] !== nextProps.store) {
      //       warnAboutReceivingStore()
      //     }
      //   }
      // }

      Provider.propTypes = {
        store: PropTypes.object.isRequired,
        children: PropTypes.element.isRequired,
      }
      Provider.childContextTypes = {
        [storeKey]: PropTypes.object.isRequired,
        [subscriptionKey]: PropTypes.object,
      }

      return Provider
    }
    // ------------------------------------------------------------------------
    // ------------------------------------------------------------------------

    const Provider = createProvider()

    // store.subscribe((mutation, state) =>Â {
    //   console.log(mutation, {...state})
    // })

    // ------------------------------------------------------------------------
    // CHILD1 COMPONENT
    // ------------------------------------------------------------------------
    class Child1 extends React.Component {
      constructor(props, context) {
        super(props, context)
        this.handleInc = this.handleInc.bind(this)
        this.handleIncAsync = this.handleIncAsync.bind(this)
      }
      handleInc() {
        this.props.onIncrement && this.props.onIncrement()
      }
      handleIncAsync() {
        this.props.onIncrementAsync && this.props.onIncrementAsync().then(console.log)
      }
      render() {
        return (
          <div>
            I am a Child1, count is {this.props.count}, {this.props.myCount}
            <button onClick={this.handleInc}>Test</button>
            <button onClick={this.handleIncAsync}>Test async</button>
          </div>
        )
      }
    }
    // ------------------------------------------------------------------------
    // ------------------------------------------------------------------------

    // ------------------------------------------------------------------------
    // PRESENTATIONAL COMPONENT
    // ------------------------------------------------------------------------
    const connect = (
      mapStateToPropsFn,
      mapMutationToPropsFn,
      mapActionToPropsFn
    ) => (Component) => {
      class PresentationalComponent extends Component {
        constructor(props, context) {
          super(props, context)
          this.store = props[storeKey] || context[storeKey]
          this.subscription = props[subscriptionKey] || context[subscriptionKey]
          this.mappedState = mapStateToPropsFn && mapStateToPropsFn(this.store.state, props)
          this.state = Object.assign(
            {},
            this.mappedState,
            mapMutationToPropsFn && mapMutationToPropsFn(this.store.commit, props),
            mapActionToPropsFn && mapActionToPropsFn(this.store.dispatch, props)
          )
          const propsKeysArray = Object.keys(this.mappedState)
          this.mappedState && store.subscribe((mutation, state) => {
            const newMappedState = mapStateToPropsFn(state)
            if(!(JSON.stringify(this.mappedState) === JSON.stringify(newMappedState))) {
              this.mappedState = newMappedState
              this.setState(mapStateToPropsFn(state))
            }
          })
        }

        componentDidUpdate() {
          console.log('componentDidUpdate')
        }

        getChildContext() {
          return {
            [subscriptionKey]: this.subscription
          }
        }

        render() {
          return React.createElement(Component, this.state)
        }
      }
      PresentationalComponent.childContextTypes = {
        [subscriptionKey]: PropTypes.object,
      }
      PresentationalComponent.contextTypes = {
        [storeKey]: PropTypes.object,
        [subscriptionKey]: PropTypes.object,
      }
      PresentationalComponent.propTypes = {
        [storeKey]: PropTypes.object,
        [subscriptionKey]: PropTypes.object,
      }
      return PresentationalComponent
    }
    // ------------------------------------------------------------------------
    // ------------------------------------------------------------------------


    const mapStateToProps = (state, ownProps) => ({
      myCount: state.count
    })
    const mapMutationToProps = (commit, ownProps) => ({
      onIncrement: () => commit(mutations.increment())
    })
    const mapActionToProps = (dispatch, ownProps) => ({
      onIncrementAsync: (val) => dispatch(actions.incrementAsync(val))
    })
    const VisibleChild1 = connect(
      mapStateToProps,
      mapMutationToProps,
      mapActionToProps
    )(Child1)


    class Main extends React.Component {
      constructor(props, context) {
        super(props, context)
        this.state = {
          count: store.state.count
        }
        store.subscribe((mutation, state) => {
          if (mutation.type === mutationTypes.INCREMENT) {
            this.setState({
              count: store.state.count
            })
          }
        })
      }

      render() {
        return (
          <div>
            <Child1 myCount={this.state.count} />
            <VisibleChild1 />
          </div>
        )
      }
    }
    class Welcome extends React.Component {
      render() {
        return (
          <div>
            <h1>Hello, {this.props.name}!</h1>
            <Provider store={store}>
              <Main />
            </Provider>
          </div>
        )
      }
    }

    ReactDOM.render(
      <div>
        <h1>Hello, world!</h1>
        <Welcome name="folks" />
      </div>,
      document.getElementById('root')
    );
  </script>
</body>

</html>
